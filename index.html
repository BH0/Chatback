<!doctype html>
<html>
  <head>
    <title>Chatback</title>
  </head>
  <body>
    <div id="nickname-container"></div>
    <div id="who-is-online"></div>
    <ul id="messages"></ul>
    <form action="">
        <input id="nickname" placeholder="nickname" /> 
        <input id="message-content" autocomplete="off" /><button>Send</button>
        <div class="emojis">
            <span>❤</span>
            <span>😢</span>
            <span>😊</span>
        </div>
    </form>
    <p id="who-is-typing"></p>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    window.onload = () => {
        let socket = io();

        fetch("/api/group-chat").then(res => res.json().then(messages => { 
            messages.forEach(message => { 
                document.querySelector("#messages").innerHTML += `<li>${message.nickname} says ${message.content}</li>`; 
            }); 
        })); 

        document.querySelector(".emojis").querySelectorAll("span").forEach(emoji => {
            emoji.addEventListener("click", emoji_e => {
                document.querySelector('#message-content').value += emoji_e.target.innerText;                
            });     
        });     

        document.querySelector("form").addEventListener("keyup", e => { 
            socket.emit("user is typing", document.querySelector('#nickname').value);
        }); 

        socket.on("user is typing", nickname => { 
            if (nickname != document.querySelector('#nickname').value) { 
                document.querySelector("#who-is-typing").innerText = `${nickname} is typing...`; 
                window.setTimeout(() => document.querySelector("#who-is-typing").innerText = "", 3000); 
            } 
        }); 

        socket.on("user online", userNicknames => { 
            console.log(userNicknames); 
            document.querySelector("#who-is-online").innerHTML = ""; 
            userNicknames.forEach(user => { 
                document.querySelector("#who-is-online").innerHTML += `<div><a href="#">${user}</a></div>`;
            }); 
        }); 

        document.querySelector("form").addEventListener("submit", e => {
            e.preventDefault(); 
            if (document.querySelector('#nickname').value != "") { 
                socket.emit('nickname', document.querySelector('#nickname').value);
                socket.emit('chat message', {nickname: document.querySelector('#nickname').value, content: document.querySelector('#message-content').value });
                document.querySelector('#message-content').value = '';
            } else { 
                alert("You must have a nickname before you can send messages"); 
            }
        });
        socket.on("chat message", message => {
            // instead create the element dynamically before appending it to the DOM here 
            document.querySelector("#messages").innerHTML += `<li>${message}</li>`;  
        }); 
        socket.on("nickname", nickname => {
            document.querySelector("#nickname-container").innerText = nickname;  
        }); 

        window.addEventListener('beforeunload', () => {
            socket.emit("user disconnected", document.querySelector('#nickname').value)
            }, false); 
        }
    </script>
    </body>
</html>