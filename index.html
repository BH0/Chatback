<!doctype html>
<html>
  <head>
    <title>Chatback</title>
  </head>
  <body>
    <form method="POST" action="/signup"> 
        <label>Signup</label>
        <input type="text" name="username-signup" /> 
        <input type="text" name="password-signup" /> 
        <input type="submit" /> 
    </form>
    <form action="" id="signin-form"> 
        <label>Signin</label>
        <input type="text" name="username-signin" id="username-signin" /> 
        <input type="text" name="password-signin" id="password-signin" /> 
        <input type="submit" /> 
    </form>
    <div id="following-list"></div>
    <form action="" id="follow-user-form" >
        <input type="text" id="user-to-follow" placeholder="user's username" /> 
    </form>
    <div id="nickname-container"></div>
    <div id="who-is-online"></div>
    <ul id="messages"></ul>
    <form action="" id="dashboard-form">
        <input id="nickname" placeholder="nickname" /> 
        <input id="message-content" autocomplete="off" /><button>Send</button>
    </form>
    <p id="who-is-typing"></p>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    window.onload = () => {
        let socket = io();
        let currentUser; 

        fetch("/api/group-chat").then(res => res.json().then(messages => { 
            messages.forEach(message => { 
                document.querySelector("#messages").innerHTML += `<li>${message.nickname} says ${message.content}</li>`; 
            }); 
        })); 

        document.querySelector("#dashboard-form").addEventListener("keyup", e => { 
            socket.emit("user is typing", document.querySelector('#nickname').value);
        }); 

        socket.on("user is typing", nickname => { 
            if (nickname != document.querySelector('#nickname').value) { 
                document.querySelector("#who-is-typing").innerText = `${nickname} is typing...`; 
                window.setTimeout(() => document.querySelector("#who-is-typing").innerText = "", 3000); 
            } 
        }); 

        socket.on("user online", userNicknames => { 
            console.log(userNicknames); 
            document.querySelector("#who-is-online").innerHTML = ""; 
            userNicknames.forEach(user => { 
                document.querySelector("#who-is-online").innerHTML += `<div><a href="/follow-user/${user}/${currentUser}">${user}</a></div>`;
            }); 
        }); 

        document.querySelector("#signin-form").addEventListener("submit", e => { 
            e.preventDefault(); 
            fetch("/signin", { 
                method: "POST", 
                body: JSON.stringify({ 
                    username: document.querySelector("#username-signin").value, 
                    password: document.querySelector("#password-signin").value
                }), 
                headers: { 
                    "Content-type": "application/json"
                } 
                }).then(res => res.json()).then(json => { 
                    currentUser = json; 
                    // console.log(currentUser[0].id) 
                    fetch(`/user-friends/${currentUser[0].id}`).then(res => res.json().then(data => {
                        data.forEach(friend => { 
                            document.querySelector("#following-list").innerHTML += `Following<div><b>${friend.friendName}</b></div>`; 
                        }); 
                    })); 
                }); 
            }); 

        document.querySelector("#follow-user-form").addEventListener("submit", e => { 
            e.preventDefault(); 
            console.log(currentUser); 
            fetch("/follow-user", { 
                method: "POST", 
                body: JSON.stringify({ 
                    username: document.querySelector("#user-to-follow").value, 
                    currentUser: currentUser
                }), 
                headers: { 
                    "Content-type": "application/json"
                } 
                }).catch(err => console.log(err)); 
            }); 

        document.querySelector("#dashboard-form").addEventListener("submit", e => {
            e.preventDefault(); 
            if (document.querySelector('#nickname').value != "") { 
                socket.emit('nickname', document.querySelector('#nickname').value);
                socket.emit('chat message', {nickname: document.querySelector('#nickname').value, content: document.querySelector('#message-content').value });
                document.querySelector('#message-content').value = '';
            } else { 
                alert("You must have a nickname before you can send messages"); 
            }
        });
        socket.on("chat message", message => {
            // instead create the element dynamically before appending it to the DOM here 
            document.querySelector("#messages").innerHTML += `<li>${message}</li>`;  
        }); 
        socket.on("nickname", nickname => {
            document.querySelector("#nickname-container").innerText = nickname;  
        }); 

        window.addEventListener('beforeunload', () => {
            socket.emit("user disconnected", document.querySelector('#nickname').value)
            }, false); 
        }
    </script>
    </body>
</html>